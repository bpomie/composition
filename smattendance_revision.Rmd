---
title: "Supplementary analyses. Early-emerging combinatorial thought: human infants flexibly combine kind and quantity concepts"
author: "BP"
output: html_document
---

# LIBRARIES
```{r}
library(tidyverse)
library(ggpubr)
library(rstatix)
```

## Paths

```{r warning=FALSE}
home_dir <- Sys.getenv("HOME")
path <- file.path(home_dir, "Documents", "GitHub", "composition", "data")
pathresults <- file.path(home_dir, "Documents", "GitHub", "composition", "results")
```

```{r}
attThreshold = 0.6
```


# TRAINING E1-3

```{r warning=FALSE}
setwd(path)
load("datatraining.RData") # Load the raw training data
str(d)
```

'propattlabeling': proportion of looking at the screen during the labeling phase of the training
'attlabeling': [0: less than 50% on-screen data during labeling; 1: 50% or more data during labeling]
Trials on which infants provided less than 50% on-screen data during labeling were excluded from further analysis.

## Introduction (overall)

Training trials, compute screen attendance during: (1) the quantity label introduction phase (overall).

```{r}
auxtrain1 <- d %>% # screen attendance during the labeling phase of the training trials
  group_by(experiment,countID,ID,trial) %>%
  filter(!phase %in% c("pretest","test")) %>%
  summarise(totalatt = sum(att, na.rm=T),
            dur = n(), #duration in samples
            propAttIntro = totalatt/dur) %>%
  mutate(validIntro = ifelse(propAttIntro >= .5,1,0))

head(auxtrain1)
```

## Introduction (labeling) & Question (baseline, response)

Training trials, compute screen attendance during: (1) the labeling events (quantity label introduction phase), (2) pretest/baseline (question phase), (3) test/response (question phase).


```{r}
auxtrain2 <- d %>%
  filter(phase %in% c("name1","name2","pretest","test")) %>%
  group_by(experiment,countID,ID,trial,phase) %>%
  summarise(totalatt = sum(att, na.rm=T),
            dur = n(),
            propAtt = totalatt/dur) %>%
  select(-dur,-totalatt) %>%
  pivot_wider(names_from = phase,values_from = c(propAtt)) %>%
  mutate(validIntroLabeling = ifelse(name1 >= .6 & name2 >= .6,1,0)) %>%
  mutate(validQuestion = ifelse(pretest >= .6 & test >= .6,1,0))

head(auxtrain2)
```

## Summary

```{r}
attentionTraining <- merge(auxtrain1,auxtrain2,by=c("experiment","countID","ID","trial")) %>%
  mutate(validTraining = ifelse(validIntro == 1 & validIntroLabeling == 1,1,0))

head(attentionTraining)
```

```{r}
rm(auxtrain1)
rm(auxtrain2)
```

## Exclusions

Identify participants who provided less than 3 valid training trials.
```{r}
attentionTraining %>%
  group_by(experiment, ID, countID) %>%
  summarise(totalValidTrainingTrials = sum(validTraining)) %>%
  filter(totalValidTrainingTrials < 3)
```

Exclude participants who provided less than 3 valid training trials.
```{r}
d <- d %>%
  filter(!countID %in% c(22,30,54,58))
```

```{r}
attentionTraining <- attentionTraining %>%
  filter(!countID %in% c(22,30,54,58))
```

Merge.

```{r}
d <- merge(d, attentionTraining, by = c("experiment","countID","ID","trial"))
```

## Save the data

```{r warning=FALSE}
setwd("~/Documents/GitHub/composition/data/") # Set the path
save(d,file = "dataTrainingAttendance.RData")
```

## Trial count

Load the results of the category recognition test in Exps 2-3.

```{r}
setwd(pathresults) # Set the path
load("resultskindrecognition.RData") # Load the raw training data
```

```{r}
resultskindindm <- resultskindindm %>%
  select(-countID)
```

```{r}
aux <- merge(attentionTraining, resultskindindm, by=c("experiment","ID"),all=T)
```

```{r}
attentionTraining <- aux
rm(aux)
```


### Overall

Compute:
- the total number of valid training trials per experiment,
- the mean number of valid training trials (+SD) per xperiment.

```{r}
attentionTraining %>%
  filter(validTraining == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment) %>%
  summarise(trialcount = n())

attentionTraining %>%
  filter(validTraining == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(trialcount = n())%>%
  group_by(experiment) %>%
  get_summary_stats(trialcount, type = "mean_sd")
```

Compute the mean proportion of screen attendence during the following parts of the quantity label introduction phase of the training:
(1) overall, (2) labeling event 1, (3) labeling event 2.

```{r}
attentionTraining %>%
  filter(validTraining == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(mlabel = mean(propAttIntro,na.rm=T),
            mname1 = mean(name1,na.rm=T),
            mname2 = mean(name2,na.rm=T)) %>%
  gather(key = "phase", value = "propatt", c("mlabel","mname1", "mname2")) %>%
  group_by(experiment,phase) %>%
  get_summary_stats(propatt, type = "mean_sd")
```

### Word mapping question

```{r}
attentionTraining %>%
  filter(validTraining == 1 & validQuestion == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment) %>%
  summarise(trialcount = n())

attentionTraining %>%
  filter(validTraining == 1 & validQuestion == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(trialcount = n())%>%
  group_by(experiment) %>%
  get_summary_stats(trialcount, type = "mean_sd")
```
### Supporting Information

```{r}
attentionTraining %>%
  filter(validTraining == 1 & validQuestion == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(mpretest = mean(pretest,na.rm=T),
            mtest = mean(test,na.rm=T)) %>%
  gather(key = "phase", value = "propatt", c("mpretest","mtest")) %>%
  ungroup() %>%
  group_by(phase) %>%
  get_summary_stats(propatt, type = "mean_sd")

attentionTraining %>%
  filter(validTraining == 1 & validQuestion == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(mlabel = mean(propAttIntro,na.rm=T),
            mname1 = mean(name1,na.rm=T),
            mname2 = mean(name2,na.rm=T)) %>%
  gather(key = "phase", value = "propatt", c("mlabel","mname1", "mname2")) %>%
  ungroup() %>%
  group_by(phase) %>%
  get_summary_stats(propatt, type = "mean_sd")

attentionTraining %>%
  filter(validTraining == 1 & validQuestion == 1) %>%
  filter((is.na(kindknower) == T & experiment == "Experiment 1") | kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(mlabel = mean(propAttIntro,na.rm=T),
            mname1 = mean(name1,na.rm=T),
            mname2 = mean(name2,na.rm=T)) %>%
  gather(key = "phase", value = "propatt", c("mlabel","mname1", "mname2")) %>%
  group_by(experiment,phase) %>%
  get_summary_stats(propatt, type = "mean_sd")
```

# GENERALIZATION E1

```{r warning=FALSE}
setwd("~/Documents/GitHub/composition/data/") # Set the path
load("datateste1.RData") # Load the raw data
```

```{r}
# Screen attendance during the entire training
attentionGeneralizationE1 <- d %>%
  group_by(ID,trial,phase) %>%
  mutate(att = ifelse(gazex>0 & gazey>0,1,0)) %>%
  summarise(totalatt = sum(att, na.rm=T),
            dur = n(),
            propatt = totalatt/dur) %>%
  select(-totalatt,-dur) %>%
  pivot_wider(names_from=phase,values_from=propatt) %>%
  mutate(validTrial = ifelse(pretest >= attThreshold & test >= attThreshold,1,0))
```

## Trial counts

Count the included trials.

```{r}
attentionGeneralizationE1 %>%
  ungroup() %>%
  filter(validTrial == 1) %>%
  summarise(n())

attentionGeneralizationE1 %>%
  group_by(ID) %>%
  filter(validTrial == 1) %>%
  summarise(trialcount = n()) %>%
  ungroup() %>%
  get_summary_stats(trialcount, type = "mean_sd")
```

```{r}
attentionGeneralizationE1 %>%
  group_by(ID) %>%
  filter(validTrial == 1) %>%
  summarise(attendancepretest = mean(pretest), attendancetest = mean(test)) %>%
  gather(key = "phase", value = "attendance", c("attendancepretest","attendancetest")) %>%
  group_by(phase) %>%
  get_summary_stats(attendance, type = "mean_sd")
```


```{r}
# Preview the excluded trials
attentionGeneralizationE1 %>%
  filter(validTrial == 0)

# Count the excluded trials
attentionGeneralizationE1 %>%
  group_by(ID) %>%
  filter(validTrial == 0) %>%
  summarise(n())
```

```{r}
colnames(attentionGeneralizationE1) <- c("ID","trial","propAttBaselineTest","propAttResponseTest","validTrial")
auxgeneralise <- merge(d,attentionGeneralizationE1,by=c("ID","trial"))
```


```{r}
d <- auxgeneralise
save(d,file = "dataattendteste1.RData")
```

```{r}
rm(auxgeneralise)
```


# COMPOSITION E2-E3

```{r}
setwd(path) # Set the path

load("datateste2.RData") # Load the raw data
d2 <- dcompose %>% 
  mutate(experiment = "Experiment 2")

load("datateste3.RData") # Load the raw data
d3 <- dcompose %>% 
  mutate(experiment = "Experiment 3")
```

```{r}
dcompose <- rbind(d2,d3)
```

```{r}
rm(d2,d3)
```

Exclude participants who provided less than 3 valid training trials.

```{r}
dcompose <- dcompose %>%
  filter(ifelse(experiment == "Experiment 2", !ID %in% c(2,10), !ID %in% c(3,7))) 
```


```{r}
attentionCompositionE2E3 <- dcompose %>%
  group_by(experiment,ID,trial,targetnumeral,phase) %>%
  summarise(totalatt = sum(att, na.rm=T),
            dur = n(),
            propatt = totalatt/dur) %>%
  select(-totalatt,-dur) %>%
  pivot_wider(names_from=phase,values_from=propatt) %>%
  mutate(validTrial = ifelse(pretest >= attThreshold & test >= attThreshold,1,0))

attentionCompositionE2E3 %>% # Excluded trials preview
  group_by(experiment,ID,targetnumeral) %>%
  filter(validTrial == 1) %>%
  summarise(trialcount = n()) %>%
  pivot_wider(names_from = targetnumeral, values_from = trialcount) %>%
  mutate(exclusion = ifelse(pair == 0 | single == 0,1,0)) %>%
  filter(exclusion == 0)

colnames(attentionCompositionE2E3) <- c("experiment", "ID","trial","targetnumeral","propAttBaselineTest","propAttResponseTest","validTrial")
auxcompose <- merge(dcompose,attentionCompositionE2E3,by=c("experiment","ID","trial","targetnumeral"))
head(auxcompose)
```

```{r}
dcompose <- auxcompose
```

```{r}
rm(auxcompose)
```


## Trial counts

```{r}
attkindcompose <- merge(attentioncompose, resultskindindm, by=c("experiment","ID"),all=T)
```


```{r}
attkindcompose %>%
  filter(trialIncluded == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment) %>%
  summarise(n())

attkindcompose %>%
  filter(trialIncluded == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(trialcount = n()) %>%
  group_by(experiment) %>%
  get_summary_stats(trialcount, type = "mean_sd")

attkindcompose %>%
  filter(trialIncluded == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(trialcount = n())
```

```{r}
attkindcompose %>%
  filter(atttrial == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment) %>%
  summarise(mean(attpretest))

attkindcompose %>%
  filter(atttrial == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment,ID) %>%
  summarise(mattpre = mean(attpretest),
            matttest = mean(atttest)) %>%
  gather(key = "phase", value = "propatt", c("mattpre","matttest")) %>%
  group_by(experiment,phase) %>%
  get_summary_stats(propatt, type = "mean_sd")
```

```{r}
attkindcompose %>%
  filter(atttrial == 1) %>%
  filter(kindknower == 1) %>%
  group_by(experiment,ID,trial) %>%
  summarise(mattpre = mean(attpretest),
            matttest = mean(atttest))
```


```{r}
setwd(path) # Set the path
save(dcompose,file = "dataattendteste2e3.RData")
```